<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini API (Google Grounding) ë°ëª¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .container {
            max-width: 800px;
            min-height: 100vh;
        }
        .card {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            padding: 24px;
        }
        .citation {
            font-size: 0.85rem;
            color: #4b5563;
            margin-top: 4px;
            display: block;
        }
        /* ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-4 flex justify-center">

    <div class="container my-8">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-8">
            Gemini API: ì‹¤ì‹œê°„ ê²€ìƒ‰ (Google Grounding) (v1.0 Test1)
        </h1>

        <!-- ì…ë ¥ ì„¹ì…˜ -->
        <div class="card mb-8">
            <h2 class="text-xl font-semibold mb-4 text-indigo-600">ì§ˆë¬¸ ì…ë ¥</h2>
            <textarea id="userInput" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 mb-4 h-24 resize-none" placeholder="ì‹¤ì‹œê°„ ì •ë³´ê°€ í•„ìš”í•œ ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”. ì˜ˆ: 'ì˜¤ëŠ˜ í™˜ìœ¨ì€ ì–¼ë§ˆì¸ê°€ìš”?' ë˜ëŠ” '2025ë…„ ì›”ë“œ ì‹œë¦¬ì¦ˆ ìš°ìŠ¹íŒ€ì€?'"></textarea>
            
            <div class="flex items-center space-x-4">
                <button id="submitButton" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg transition duration-150 flex items-center justify-center disabled:opacity-50">
                    <span id="buttonText">ì •ë³´ ê²€ìƒ‰í•˜ê¸°</span>
                    <div id="loadingSpinner" class="loader hidden ml-2"></div>
                </button>
                <p class="text-sm text-gray-500 italic">
                    (Gemini-2.5-flash ëª¨ë¸ê³¼ Google Search Tool ì‚¬ìš©)
                </p>
            </div>
            
        </div>

        <!-- ê²°ê³¼ ì„¹ì…˜ -->
        <div class="card">
            <h2 class="text-xl font-semibold mb-4 text-indigo-600">ê²€ìƒ‰ ê²°ê³¼</h2>
            <div id="responseOutput" class="min-h-[100px] p-3 bg-gray-50 border border-gray-200 rounded-lg whitespace-pre-wrap">
                ê²€ìƒ‰ ê²°ê³¼ë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...
            </div>

            <!-- ì¸ìš© ì„¹ì…˜ -->
            <div id="citationArea" class="mt-4 border-t border-gray-200 pt-4 hidden">
                <h3 class="text-base font-semibold mb-2 text-gray-700">ì¸ìš©ëœ ì¶œì²˜ (Grounding Sources)</h3>
                <div id="sourcesList" class="space-y-2">
                    <!-- ì¸ìš© ëª©ë¡ì´ ì—¬ê¸°ì— ì¶”ê°€ë©ë‹ˆë‹¤. -->
                </div>
            </div>
            
            <div id="errorDisplay" class="hidden mt-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg">
                <strong>ì˜¤ë¥˜ ë°œìƒ:</strong> <span id="errorText"></span>
            </div>
        </div>

    </div>

    <script>
        // API ì„¤ì • (Canvas í™˜ê²½ì—ì„œ __initial_auth_tokenì´ ì œê³µë˜ì§€ ì•Šìœ¼ë¯€ë¡œ, API Keyë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.)
        // Canvas í™˜ê²½ì—ì„œ ìë™ìœ¼ë¡œ API í‚¤ê°€ ì£¼ì…ë˜ë¯€ë¡œ, ë¹ˆ ë¬¸ìì—´ë¡œ ìœ ì§€í•©ë‹ˆë‹¤.
		// âœ… ì¶”ê°€í•  ì½”ë“œ (í”„ë¡ì‹œ ì—”ë“œí¬ì¸íŠ¸)
		const PROXY_URL = '/api/gemini-proxy';
		
        // DOM ìš”ì†Œ
        const userInput = document.getElementById('userInput');
        const submitButton = document.getElementById('submitButton');
        const buttonText = document.getElementById('buttonText');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const responseOutput = document.getElementById('responseOutput');
        const citationArea = document.getElementById('citationArea');
        const sourcesList = document.getElementById('sourcesList');
        const errorDisplay = document.getElementById('errorDisplay');
        const errorText = document.getElementById('errorText');

        // ìƒíƒœ ê´€ë¦¬
        let isProcessing = false;

        /**
         * ì§€ìˆ˜ ë°±ì˜¤í”„ë¥¼ ì‚¬ìš©í•˜ì—¬ API í˜¸ì¶œì„ ì‹œë„í•©ë‹ˆë‹¤.
         * @param {object} payload - API ìš”ì²­ í˜ì´ë¡œë“œ
         * @param {number} maxRetries - ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜
         * @param {number} delay - ì´ˆê¸° ì§€ì—° ì‹œê°„ (ë°€ë¦¬ì´ˆ)
         * @returns {Promise<object>} API ì‘ë‹µ JSON
         */
        async function fetchWithBackoff(payload, maxRetries = 5, delay = 1000) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(PROXY_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        return await response.json();
                    } 
                    
                    // 429 (Rate Limit) ë˜ëŠ” 5xx (Server Error)ì¼ ê²½ìš° ì¬ì‹œë„
                    if (response.status === 429 || response.status >= 500) {
                        if (i < maxRetries - 1) {
                            await new Promise(resolve => setTimeout(resolve, delay * (2 ** i)));
                            continue; // ë‹¤ìŒ ë£¨í”„ë¡œ ì´ë™í•˜ì—¬ ì¬ì‹œë„
                        }
                    }
                    
                    // ê¸°íƒ€ ì˜¤ë¥˜ëŠ” ì¦‰ì‹œ ì²˜ë¦¬
                    const errorJson = await response.json();
                    throw new Error(`API ìš”ì²­ ì‹¤íŒ¨ (HTTP ${response.status}): ${JSON.stringify(errorJson)}`);

                } catch (error) {
                    // ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë˜ëŠ” JSON íŒŒì‹± ì˜¤ë¥˜ ì²˜ë¦¬
                    if (i === maxRetries - 1) {
                        throw new Error(`API í˜¸ì¶œ ì¤‘ ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜ ì´ˆê³¼: ${error.message}`);
                    }
                    // ë‹¤ìŒ ì¬ì‹œë„ë¥¼ ìœ„í•´ ëŒ€ê¸°
                    await new Promise(resolve => setTimeout(resolve, delay * (2 ** i)));
                }
            }
        }


        /**
         * Gemini APIë¥¼ í˜¸ì¶œí•˜ì—¬ ë‹µë³€ê³¼ ì¸ìš©ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
         */
        async function getGroundingResponse(query) {
            // ì‹œìŠ¤í…œ ëª…ë ¹ì–´: ë‹µë³€ ë°©ì‹ì„ ì•ˆë‚´
            const systemPrompt = "ë‹¹ì‹ ì€ Google Search Grounding ë„êµ¬ë¥¼ ì‚¬ìš©í•˜ì—¬ ì§ˆë¬¸ì— ëŒ€í•œ ìµœì‹  ì •ë³´ë¥¼ ì œê³µí•˜ëŠ” ì¹œì ˆí•œ AI ì–´ì‹œìŠ¤í„´íŠ¸ì…ë‹ˆë‹¤. í•­ìƒ ì‹¤ì‹œê°„ ê²€ìƒ‰ì„ í†µí•´ ì–»ì€ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë‹µë³€í•´ì£¼ì„¸ìš”. ë‹µë³€ì€ í•œêµ­ì–´ë¡œ ê°„ê²°í•˜ê²Œ ìš”ì•½ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.";

            const payload = {
                contents: [{ parts: [{ text: query }] }],
                
                // Google Search Grounding ë„êµ¬ í™œì„±í™” (ì‹¤ì‹œê°„ ê²€ìƒ‰)
                tools: [{ "google_search": {} }], 
                
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
                
				// ğŸš€ ì´ ë¶€ë¶„ì„ 'config' ëŒ€ì‹  'generationConfig'ë¡œ ìˆ˜ì •í•´ì•¼ í•©ë‹ˆë‹¤.
                generationConfig: { 
                    maxOutputTokens: 8192, 
                },
            };

            const result = await fetchWithBackoff(payload);
            
            const candidate = result.candidates?.[0];
            
            if (candidate && candidate.content?.parts?.[0]?.text) {
                const text = candidate.content.parts[0].text;
                let sources = [];
                
                // Grounding ì†ŒìŠ¤ ì¶”ì¶œ
                const groundingMetadata = candidate.groundingMetadata;
                if (groundingMetadata && groundingMetadata.groundingAttributions) {
                    sources = groundingMetadata.groundingAttributions
                        .map(attribution => ({
                            uri: attribution.web?.uri,
                            title: attribution.web?.title,
                        }))
                        .filter(source => source.uri && source.title); // ìœ íš¨í•œ ì†ŒìŠ¤ë§Œ í•„í„°ë§
                }

                return { text, sources };
            } else {
                throw new Error("Geminië¡œë¶€í„° ìœ íš¨í•œ ì‘ë‹µì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. (í›„ë³´/íŒŒíŠ¸/í…ìŠ¤íŠ¸ ëˆ„ë½)");
            }
        }

        /**
         * UI ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
         */
        function updateUIState(loading, error = null) {
            isProcessing = loading;
            submitButton.disabled = loading;
            userInput.disabled = loading;
            
            buttonText.textContent = loading ? "ê²€ìƒ‰ ì¤‘..." : "ì •ë³´ ê²€ìƒ‰í•˜ê¸°";
            loadingSpinner.classList.toggle('hidden', !loading);

            errorDisplay.classList.add('hidden');
            if (error) {
                errorText.textContent = error;
                errorDisplay.classList.remove('hidden');
            }
        }

        /**
         * ê²°ê³¼ë¥¼ UIì— í‘œì‹œí•©ë‹ˆë‹¤.
         */
        function displayResults(text, sources) {
            responseOutput.textContent = text;
            sourcesList.innerHTML = ''; // ê¸°ì¡´ ì¸ìš© ëª©ë¡ ì´ˆê¸°í™”
            citationArea.classList.add('hidden');

            if (sources && sources.length > 0) {
                citationArea.classList.remove('hidden');
                
                sources.forEach((source, index) => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <a href="${source.uri}" target="_blank" class="text-indigo-600 hover:text-indigo-800 break-words underline">
                            [${index + 1}] ${source.title || source.uri}
                        </a>
                    `;
                    sourcesList.appendChild(li);
                });
            }
        }


        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        submitButton.addEventListener('click', async () => {
            if (isProcessing) return;

            const query = userInput.value.trim();
            if (!query) {
                updateUIState(false, "ì§ˆë¬¸ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
                return;
            }

            // UI ì´ˆê¸°í™” ë° ë¡œë”© ì‹œì‘
            responseOutput.textContent = "ê²€ìƒ‰ ê²°ê³¼ë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...";
            citationArea.classList.add('hidden');
            updateUIState(true);

            try {
                const { text, sources } = await getGroundingResponse(query);
                displayResults(text, sources);
                updateUIState(false);
            } catch (error) {
                console.error("ì‹¤ì‹œê°„ ê²€ìƒ‰ ì˜¤ë¥˜:", error);
                responseOutput.textContent = "ì˜¤ë¥˜ë¡œ ì¸í•´ ë‹µë³€ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ì—ˆìŠµë‹ˆë‹¤.";
                updateUIState(false, error.message);
            }
        });
    </script>
</body>
</html>


